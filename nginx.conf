##
# Wetty SSH Terminal - nginx Configuration
##
# This configuration provides rate limiting for the wetty web-based SSH terminal
#
# ARCHITECTURE:
#   Internet → System nginx (HTTPS/SSL) → This nginx (port 3002) → Wetty (port 3000)
#
# RATE LIMITING STRATEGY:
#   - Three-tier approach based on resource type and security requirements
#   - All limits are PER IP ADDRESS (not global)
#   - Custom 429 error page shows when limits are exceeded
#
# QUICK REFERENCE:
#   Global rate:      30 requests/second per IP
#   Static files:     NO rate limiting (essential for functionality)
#   WebSocket/SSH:    30 req/s, burst 10, max 5 concurrent connections
#   Page loads:       30 req/s, burst 100, max 10 concurrent connections
#
# TO ADJUST LIMITS:
#   - Line 19: Change global rate (e.g., rate=50r/s for 50 requests/second)
#   - Line 78: Change WebSocket burst (e.g., burst=20 for more retries)
#   - Line 82: Change max SSH sessions (e.g., limit_conn wetty_conn 10)
#   - Line 108: Change page load burst (e.g., burst=200 for more refreshes)
#
# TO DISABLE RATE LIMITING:
#   Comment out all limit_req and limit_conn directives in location blocks
##

events {
    worker_connections 1024;
}

http {
    ##
    # Rate Limiting Configuration
    ##
    # Strategy: Three-tier rate limiting for different resource types
    # 1. Static files (CSS/JS/images) - NO rate limiting
    # 2. WebSocket/SSH connections - STRICT limiting (30 req/s, burst 10)
    # 3. HTML/page loads - MODERATE limiting (30 req/s, burst 100)
    #
    # All limits are PER IP ADDRESS (not global)
    # Memory: 10MB can track ~160,000 unique IP addresses
    ##

    # Global rate: 30 requests per second per IP address
    limit_req_zone $binary_remote_addr zone=wetty_limit:10m rate=30r/s;

    # Connection limiting: max concurrent connections per IP
    # Used in location blocks to set specific limits
    limit_conn_zone $binary_remote_addr zone=wetty_conn:10m;

    # HTTP status code returned when rate limit is exceeded
    limit_req_status 429;
    limit_conn_status 429;

    upstream wetty_backend {
        server wetty:3000;
    }

    server {
        listen 3002;
        server_name _;

        # Custom error page for rate limiting
        error_page 429 /429.html;
        location = /429.html {
            root /usr/share/nginx/html;
            internal;
        }

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        ##
        # TIER 1: Static assets - NO rate limiting
        ##
        # Rationale: These files are essential for page functionality and safe to serve without limits
        # They don't consume significant server resources and blocking them breaks the page
        # Caching reduces repeated requests to the backend
        ##
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://wetty_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Cache static assets for 1 hour
            expires 1h;
            add_header Cache-Control "public";
        }

        ##
        # TIER 2: WebSocket/Socket.io connections - STRICT rate limiting
        ##
        # Rationale: This is where SSH connections are established
        # Stricter limits prevent connection flooding and brute force attempts
        # Each established connection stays open, so limit concurrent connections
        ##
        location /socket.io/ {
            # Rate: 30 req/s with burst of 10 (allows connection retries)
            limit_req zone=wetty_limit burst=10 nodelay;

            # Max 5 concurrent SSH sessions per IP
            # Adjust higher if users need multiple simultaneous sessions
            limit_conn wetty_conn 5;

            proxy_pass http://wetty_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts for SSH sessions
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }

        ##
        # TIER 3: All other requests - MODERATE rate limiting
        ##
        # Rationale: Handles HTML pages and other non-static content
        # High burst allows initial page load with all resources
        # Prevents abuse while allowing normal usage (refreshes, navigation)
        ##
        location / {
            # Rate: 30 req/s with burst of 100 (allows multiple page loads/refreshes)
            limit_req zone=wetty_limit burst=100 nodelay;

            # Max 10 concurrent connections per IP (for page loads)
            limit_conn wetty_conn 10;

            # WebSocket proxy settings for wetty
            proxy_pass http://wetty_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
        }
    }
}
